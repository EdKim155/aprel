# Архитектура проекта

## Общая структура

```
┌─────────────────────────────────────────────────────────────┐
│                      Telegram Bot API                       │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                        bot.py                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Handlers (CommandHandler, CallbackQueryHandler)    │   │
│  └─────────────────────────────────────────────────────┘   │
└────┬────────────────┬────────────────┬──────────────────────┘
     │                │                │
     ▼                ▼                ▼
┌─────────┐    ┌─────────────┐   ┌──────────┐
│ config  │    │  keyboards  │   │  utils   │
│   .py   │    │     .py     │   │   .py    │
└─────────┘    └─────────────┘   └──────────┘
     │
     ▼
┌──────────────────────────────────────────┐
│           database.py                    │
│  ┌────────────────────────────────────┐ │
│  │  - Users                            │ │
│  │  - Shipments                        │ │
│  │  - Logs                             │ │
│  │  - TestSessions                     │ │
│  └────────────────────────────────────┘ │
└────────────────┬─────────────────────────┘
                 │
                 ▼
         ┌──────────────┐
         │  bot.db      │
         │  (SQLite)    │
         └──────────────┘
```

## Компоненты системы

### 1. bot.py - Главный модуль
Основной файл приложения, содержащий:
- Инициализацию бота и диспетчера
- Обработчики команд и callback-запросов
- Машину состояний (FSM) для режима тестирования
- Планировщик задач (APScheduler)

**Основные обработчики:**
- `/start` - Точка входа, приветствие
- Callback-обработчики для inline-кнопок
- Админские команды (`/admin_*`)
- Система тестирования скорости

### 2. config.py - Конфигурация
Загружает настройки из переменных окружения (.env файл):
- `BOT_TOKEN` - Токен Telegram бота
- `ADMIN_IDS` - Список ID администраторов
- `BOOKING_TIME` - Время автоматического открытия бронирования
- `TEST_SHIPMENTS` - Список тестовых перевозок
- `DEFAULT_SHIPMENTS` - Перевозки по умолчанию

### 3. database.py - Работа с БД
Асинхронные функции для работы с SQLite:

**Функции пользователей:**
- `add_user()` - Регистрация пользователя
- `get_user()` - Получение данных пользователя

**Функции перевозок:**
- `add_shipment()` - Добавление перевозки
- `get_shipments()` - Получение списка перевозок
- `book_shipment()` - Бронирование перевозки
- `get_user_bookings()` - Бронирования пользователя

**Функции логирования:**
- `add_log()` - Запись действия в лог
- `get_user_logs()` - Получение логов пользователя

**Функции тестовых сессий:**
- `create_test_session()` - Создание сессии теста
- `update_test_session_start()` - Обновление времени /start
- `complete_test_session()` - Завершение теста с результатами
- `get_test_sessions()` - Получение статистики тестов

**Административные функции:**
- `reset_bookings()` - Сброс всех бронирований
- `get_stats()` - Общая статистика

### 4. keyboards.py - Клавиатуры
Генерация inline-клавиатур:
- `get_main_menu()` - Главное меню (5 кнопок)
- `get_shipments_keyboard()` - Список перевозок
- `get_shipment_detail_keyboard()` - Детали перевозки
- `get_back_to_menu_keyboard()` - Кнопка назад
- `get_test_result_keyboard()` - Результаты теста

### 5. utils.py - Вспомогательные функции
Утилиты для форматирования и измерения:

**Класс Timer:**
- `start()` - Начать отсчет
- `stop()` - Остановить и вернуть время в мс
- `get_elapsed()` - Получить текущее время

**Функции форматирования:**
- `format_shipment_info()` - Информация о перевозке
- `format_test_results()` - Результаты теста
- `format_booking_result()` - Результат бронирования
- `format_stats()` - Статистика
- `format_user_logs()` - Логи пользователя

## Схема базы данных

```sql
┌─────────────────────┐
│       users         │
├─────────────────────┤
│ user_id (PK)        │
│ username            │
│ first_name          │
│ registration_date   │
└─────────────────────┘
          │
          │ (1:N)
          │
┌─────────┴───────────┐
│     shipments       │
├─────────────────────┤
│ id (PK)             │
│ type                │
│ city                │
│ quantity            │
│ is_booked           │
│ booked_by (FK)      │──┐
│ booked_at           │  │
│ is_test             │  │
└─────────────────────┘  │
                         │
          ┌──────────────┘
          │
┌─────────┴───────────┐
│       logs          │
├─────────────────────┤
│ id (PK)             │
│ user_id (FK)        │
│ action              │
│ timestamp           │
│ response_time_ms    │
│ success             │
│ is_test_mode        │
│ test_stage          │
└─────────────────────┘
          │
          │ (1:N)
          │
┌─────────┴───────────┐
│   test_sessions     │
├─────────────────────┤
│ id (PK)             │
│ user_id (FK)        │
│ test_start_time     │
│ start_command_time  │
│ selection_time      │
│ total_time_ms       │
│ stage1_time_ms      │
│ stage2_time_ms      │
└─────────────────────┘
```

## Поток данных

### Обычное бронирование

```
Пользователь
    │
    │ /start
    ▼
┌────────────────┐
│  Главное меню  │
└────────┬───────┘
         │ Выбор типа
         ▼
┌─────────────────┐
│ Список перевозок│
└────────┬────────┘
         │ Выбор перевозки
         ▼
┌─────────────────┐
│    Детали       │◄───── Timer.start()
└────────┬────────┘
         │ Подтвердить
         ▼
┌─────────────────┐
│  book_shipment()│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│    Результат    │◄───── Timer.stop()
│  + время (мс)   │
└─────────────────┘
         │
         ▼
     add_log()
```

### Режим тестирования

```
Пользователь
    │
    │ Нажал "🧪 Тест"
    ▼
┌──────────────────────┐
│ create_test_session()│
│ Timer.start()        │◄───── Время T0
└──────────┬───────────┘
           │
           │ Отправка SMS
           ▼
┌──────────────────────┐
│ "Появились новые     │
│  перевозки..."       │
└──────────┬───────────┘
           │
           │ /start
           ▼
┌──────────────────────┐
│ update_test_session  │
│ _start()             │◄───── Время T1
│ Stage1 = T1 - T0     │
└──────────┬───────────┘
           │
           │ Список тестовых
           │ перевозок
           ▼
┌──────────────────────┐
│ Пользователь         │
│ выбирает перевозку   │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ complete_test_       │◄───── Время T2
│ session()            │
│ Stage2 = T2 - T1     │
│ Total = T2 - T0      │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Отображение          │
│ результатов:         │
│ - Stage1 (мс)        │
│ - Stage2 (мс)        │
│ - Total (мс)         │
└──────────────────────┘
```

### Автоматическое уведомление

```
APScheduler
    │
    │ Cron: каждый день
    │ в BOOKING_TIME
    ▼
┌────────────────────────┐
│ scheduled_booking_open()│
└────────┬───────────────┘
         │
         ▼
┌────────────────────────┐
│ Получить всех          │
│ пользователей из БД    │
└────────┬───────────────┘
         │
         │ Для каждого
         ▼
┌────────────────────────┐
│ bot.send_message()     │
│ "Появились новые       │
│  перевозки..."         │
└────────────────────────┘
```

## FSM (Finite State Machine) - Машина состояний

Используется для режима тестирования:

```
┌────────┐
│  None  │ (начальное состояние)
└───┬────┘
    │
    │ Нажата кнопка "🧪 Тест"
    ▼
┌─────────────────────┐
│ waiting_for_start   │
└─────────┬───────────┘
          │
          │ Пользователь отправил /start
          ▼
┌─────────────────────┐
│ waiting_for_        │
│ selection           │
└─────────┬───────────┘
          │
          │ Пользователь выбрал перевозку
          ▼
┌─────────────────────┐
│  None               │ (завершено)
│  Отображены         │
│  результаты         │
└─────────────────────┘
```

## Особенности реализации

### Асинхронность
Все операции с I/O (база данных, Telegram API) выполняются асинхронно:
- `async def` функции
- `await` для асинхронных вызовов
- `aiosqlite` для асинхронной работы с SQLite
- `aiogram` - асинхронная библиотека для Telegram

### Защита от конкурентного доступа
При бронировании используется атомарная операция SQL:
```sql
UPDATE shipments 
SET is_booked = 1, booked_by = ?, booked_at = ? 
WHERE id = ? AND is_booked = 0
```
Проверка `changes()` показывает, было ли изменение.
Если 0 - значит кто-то другой уже забронировал.

### Измерение времени
- Используется `time.time()` для точности
- Результат в миллисекундах (умножение на 1000)
- Округление до 3 знаков после запятой

### Логирование
Все действия пользователей записываются в БД:
- Timestamp с точностью до миллисекунды
- Тип действия
- Время обработки
- Успешность операции
- Режим теста (если применимо)

## Расширяемость

### Добавление нового типа перевозок
1. Добавить тип в `config.DEFAULT_SHIPMENTS`
2. Добавить кнопку в `keyboards.get_main_menu()`
3. Добавить обработчик в `bot.py`

### Добавление новой админской команды
1. Добавить обработчик с декоратором `@router.message(Command('admin_новая_команда'))`
2. Проверить `message.from_user.id in config.ADMIN_IDS`
3. Реализовать логику

### Изменение времени открытия бронирования
Можно реализовать динамическое изменение:
```python
scheduler.reschedule_job(
    'booking_open',
    trigger='cron',
    hour=новый_час,
    minute=новая_минута
)
```

## Безопасность

### Защита админских команд
Все админские команды проверяют:
```python
if message.from_user.id not in config.ADMIN_IDS:
    await message.answer("❌ У вас нет прав администратора")
    return
```

### Защита от SQL-инъекций
Используются параметризованные запросы:
```python
await db.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
```

### Хранение токена
Токен хранится в `.env` файле, который добавлен в `.gitignore`

## Производительность

### Индексы БД
SQLite автоматически создает индексы для PRIMARY KEY.
Для дополнительной оптимизации можно добавить:
```sql
CREATE INDEX idx_shipments_type ON shipments(type);
CREATE INDEX idx_logs_user_id ON logs(user_id);
```

### Кэширование
В текущей версии не используется Redis.
Можно добавить кэширование для:
- Списков перевозок
- Статистики
- Информации о пользователях

### Ограничение конкурентности
aiogram автоматически обрабатывает множественные запросы.
SQLite поддерживает конкурентное чтение, но блокирует запись.
