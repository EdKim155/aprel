# Руководство по интеграции - Бот + Клиент

## Обзор системы

Проект состоит из **двух компонентов**, которые работают вместе:

1. **Telegram Bot (Сервер)** - Симулирует систему бронирования перевозок
2. **Auto Booking Client (Клиент)** - Автоматически бронирует через бота

```
┌─────────────────────┐         ┌─────────────────────┐
│                     │         │                     │
│   TELEGRAM BOT      │◄───────►│  BOOKING CLIENT     │
│   (bot.py)          │         │  (main.py)          │
│                     │         │                     │
│  - Bot API          │         │  - Client API       │
│  - SQLite DB        │         │  - Telethon         │
│  - /start, /admin   │         │  - Auto booking     │
│  - SMS notifications│         │  - < 150ms speed    │
│                     │         │                     │
└─────────────────────┘         └─────────────────────┘
         ↓                               ↓
    [Database]                      [Sessions]
     bot.db                         sessions/
```

## 🚀 Полная установка (оба компонента)

### Шаг 1: Подготовка окружения

```bash
# Перейти в директорию проекта
cd aprel

# Убедиться что Python 3.10+ установлен
python3 --version
```

### Шаг 2: Установка бота (сервер)

```bash
# Создать виртуальное окружение для бота
python3 -m venv venv
source venv/bin/activate

# Установить зависимости бота
pip install -r requirements.txt

# Настроить бот
cp .env.example .env
nano .env
```

Заполнить `.env`:
```env
BOT_TOKEN=your_bot_token_from_BotFather
ADMIN_IDS=your_telegram_user_id
BOOKING_TIME=11:30
```

### Шаг 3: Установка клиента

```bash
# Деактивировать текущее окружение (если активно)
deactivate

# Запустить установку клиента
./setup_client.sh

# Настроить клиент
nano config.yaml
```

Заполнить `config.yaml`:
```yaml
telegram:
  api_id: 12345678              # От my.telegram.org
  api_hash: "your_api_hash"
  phone: "+79991234567"

bot:
  username: "your_bot_username"  # БЕЗ @

targets:
  - cities: ["Челябинск"]
    priority: 1

performance:
  polling_interval_ms: 30
```

## 📱 Тестирование полной системы

### Сценарий 1: Ручное тестирование

**Терминал 1 - Запуск бота:**
```bash
cd aprel
source venv/bin/activate  # Окружение бота
python bot.py
```

**Терминал 2 - Запуск клиента:**
```bash
cd aprel
source venv/bin/activate  # То же окружение или отдельное
python main.py --mode immediate
```

**Telegram:**
1. Найти бота в Telegram
2. Отправить `/start`
3. Нажать кнопку **"🧪 Тест"**

**Результат:**
Клиент автоматически:
- Обнаружит SMS от бота
- Отправит `/start`
- Выберет перевозку
- Подтвердит бронирование
- Покажет статистику (< 150ms)

### Сценарий 2: Запланированное бронирование

**1. Настроить время в боте** (`.env`):
```env
BOOKING_TIME=15:30  # Например, 15:30
```

**2. Настроить время в клиенте** (`config.yaml`):
```yaml
booking:
  target_time: "15:30:00"  # То же время
```

**3. Запустить бот:**
```bash
python bot.py
```

Бот автоматически отправит SMS всем пользователям в 15:30.

**4. Запустить клиент в режиме scheduled:**
```bash
python main.py --mode scheduled
```

Клиент будет:
- Ждать до 15:29:00 (за 60 сек)
- Подготовится
- В 15:29:50 начнет интенсивный мониторинг
- При получении SMS выполнит бронирование

## 🔄 Рабочий процесс

### Что делает бот:

1. **Запуск и инициализация**
   ```
   bot.py → Подключение к Telegram Bot API
          → Создание базы данных
          → Загрузка перевозок
          → Запуск планировщика
   ```

2. **Обработка команд пользователей**
   - `/start` - главное меню
   - Просмотр перевозок
   - Бронирование
   - "🧪 Тест" - тестовый режим

3. **В тестовом режиме:**
   ```
   Пользователь нажимает "🧪 Тест"
   → Бот создает тестовые перевозки
   → Отправляет SMS-уведомление
   → Ждет действий пользователя
   → Измеряет время реакции
   ```

4. **В продакшн режиме:**
   ```
   В 11:30:00 (или другое время)
   → Бот открывает бронирование
   → Отправляет SMS всем пользователям
   → Обрабатывает бронирования
   → Логирует результаты
   ```

### Что делает клиент:

1. **Режим immediate (тестирование)**
   ```
   main.py --mode immediate
   → Подключение к Telegram
   → Начало мониторинга
   → Ожидание SMS от бота
   → Выполнение бронирования
   → Вывод статистики
   ```

2. **Режим scheduled (продакшн)**
   ```
   main.py --mode scheduled
   → Подключение к Telegram
   → Ожидание времени подготовки
   → Подготовка (за 60 сек)
   → Интенсивный мониторинг (за 10 сек)
   → Обнаружение SMS
   → Ультра-быстрое бронирование
   → Уведомление пользователя
   ```

## 📊 Временная диаграмма

### Тестовый режим:

```
Время  | Бот                      | Клиент
-------|--------------------------|---------------------------
00:00  | Ожидание                 | python main.py --mode immediate
00:05  | Пользователь: 🧪 Тест   | Мониторинг SMS...
00:06  | Создание тестов          |
00:07  | Отправка SMS             |
00:08  |                          | ✓ SMS обнаружено (47ms)
00:09  |                          | → /start отправлено
00:10  | Обработка /start         |
00:11  | Отправка меню            |
00:12  |                          | ✓ Меню получено (38ms)
00:13  |                          | → Клик на перевозку
00:14  | Обработка выбора         |
00:15  | Отправка подтверждения   |
00:16  |                          | ✓ Подтверждение (32ms)
00:17  |                          | → Клик "Подтвердить"
00:18  | Бронирование             |
00:19  | Отправка результата      |
00:20  |                          | ✓ Результат получен
00:21  |                          | 📊 Статистика: 117ms
```

### Продакшн режим:

```
Время  | Бот                      | Клиент
-------|--------------------------|---------------------------
11:29:00| Ожидание времени        | Подготовка начата
11:29:10| Ожидание времени        | Отправка /start (подготовка)
11:29:50| Ожидание времени        | Интенсивный мониторинг (30ms)
11:30:00| Открытие бронирования   | Мониторинг...
11:30:00| Отправка SMS всем       | 
11:30:00|                          | ✓ SMS обнаружено!
11:30:00|                          | → Ультра-быстрое бронирование
11:30:00| Обработка запросов      |
11:30:01| Первое бронирование ✓   | ✓ Успех! (< 150ms)
```

## 🎯 Сценарии использования

### Сценарий A: Разработка и отладка

**Цель:** Протестировать работу клиента

**Действия:**
1. Запустить бота локально
2. Запустить клиент в режиме immediate
3. Использовать "🧪 Тест" в боте
4. Наблюдать логи в обоих терминалах
5. Анализировать метрики

**Преимущества:**
- Полный контроль
- Детальное логирование
- Возможность отладки

### Сценарий B: Продакшн использование

**Цель:** Реальное бронирование в заданное время

**Действия:**
1. Бот работает как сервис (systemd)
2. Клиент запускается за 5 минут до времени
3. Клиент выполняет бронирование
4. Получение уведомления о результате

**Преимущества:**
- Автоматизация
- Надежность
- Минимальное время реакции

### Сценарий C: Тестирование производительности

**Цель:** Измерить скорость работы

**Действия:**
1. Запустить бота
2. Запустить test_client.py для проверки компонентов
3. Выполнить несколько тестовых прогонов
4. Анализировать метрики в логах
5. Оптимизировать параметры

**Метрики для анализа:**
- SMS detection time
- Stage 1 time (SMS → /start)
- Stage 2 time (/start → select)
- Stage 3 time (select → confirm)
- Total time

## 🔧 Конфигурация для разных сценариев

### Для максимальной скорости:

**Клиент (config.yaml):**
```yaml
performance:
  polling_interval_ms: 30       # Минимум для быстрого обнаружения
  max_retries: 1                # Быстрый fail-fast
  connection_timeout: 5         # Короткий таймаут
```

### Для стабильности:

**Клиент (config.yaml):**
```yaml
performance:
  polling_interval_ms: 50       # Меньше нагрузка на API
  max_retries: 5                # Больше попыток при ошибках
  connection_timeout: 15        # Длинный таймаут
```

### Для тестирования:

**Бот (.env):**
```env
BOOKING_TIME=11:30
TEST_MODE_ENABLED=true
```

**Клиент (config.yaml):**
```yaml
notifications:
  telegram_notify: false        # Не слать уведомления в Telegram
  sound_alert: false            # Не воспроизводить звуки
```

## 📝 Логи и отладка

### Просмотр логов бота:

```bash
# Последние 50 строк
tail -50 logs/booking_client.log

# Следить за логами в реальном времени
tail -f logs/booking_client.log

# Поиск ошибок
grep ERROR logs/booking_client.log
```

### Просмотр логов клиента:

```bash
# Текстовые логи
tail -f logs/booking_client.log

# JSON логи (для анализа)
cat logs/booking_client_json.log | jq '.details'

# Фильтр по действиям
cat logs/booking_client_json.log | jq 'select(.action=="booking_attempt")'
```

### Синхронная отладка:

**Терминал 1:**
```bash
python bot.py 2>&1 | tee bot_debug.log
```

**Терминал 2:**
```bash
python main.py --mode immediate 2>&1 | tee client_debug.log
```

## 🚨 Типичные проблемы и решения

### Проблема 1: Клиент не видит SMS

**Причина:** Username бота неправильный или диалог не начат

**Решение:**
1. Проверить `bot.username` в config.yaml (БЕЗ @)
2. Отправить `/start` боту вручную хотя бы раз
3. Проверить что бот запущен

### Проблема 2: Бот не реагирует на команды

**Причина:** Бот не запущен или токен неверный

**Решение:**
1. Проверить что `python bot.py` запущен
2. Проверить BOT_TOKEN в .env
3. Проверить логи бота

### Проблема 3: Медленное бронирование (> 200ms)

**Причина:** Сетевые задержки или высокая загрузка

**Решение:**
1. Уменьшить polling_interval_ms до 30
2. Проверить ping до Telegram серверов
3. Закрыть ненужные программы
4. Использовать проводное соединение

### Проблема 4: FloodWaitError

**Причина:** Слишком много запросов

**Решение:**
1. Увеличить polling_interval_ms
2. Подождать указанное время
3. Не запускать несколько клиентов одновременно

## 📈 Мониторинг производительности

### Метрики бота:

```bash
# Через админ команду
/admin_stats

# Через админ команду для тестов
/admin_test_stats
```

### Метрики клиента:

Автоматически выводятся после каждого бронирования:

```
SMS → /start:     47ms
/start → выбор:   38ms
Выбор → подтверд: 32ms
━━━━━━━━━━━━━━━━━━━━
Общее время:     117ms
```

### Анализ JSON логов:

```bash
# Средее время бронирования
cat logs/booking_client_json.log | \
  jq -r 'select(.action=="booking_attempt") | .details.total_time_ms' | \
  awk '{sum+=$1; n++} END {print "Average:", sum/n, "ms"}'

# Самое быстрое бронирование
cat logs/booking_client_json.log | \
  jq -r 'select(.action=="booking_attempt") | .details.total_time_ms' | \
  sort -n | head -1
```

## 🎓 Рекомендации

### Для разработки:

1. Запускать бота и клиента в отдельных терминалах
2. Использовать режим immediate для тестов
3. Проверять логи после каждого теста
4. Экспериментировать с параметрами конфигурации

### Для продакшна:

1. Запускать бота как systemd service
2. Запускать клиента за 5 минут до времени
3. Настроить уведомления
4. Делать backup сессий регулярно
5. Мониторить логи

### Для оптимизации:

1. Тестировать в разное время суток
2. Измерять ping до Telegram
3. Профилировать узкие места
4. Оптимизировать polling_interval_ms
5. Использовать SSD для сессий

## 🎯 Заключение

Система состоит из двух компонентов, которые отлично работают вместе:

- **Бот** обеспечивает серверную часть и управление бронированиями
- **Клиент** обеспечивает ультра-быструю автоматизацию

При правильной настройке система обеспечивает:
- ✅ Время реакции < 150ms
- ✅ Высокую надежность
- ✅ Детальное логирование
- ✅ Простоту использования

---

**Полная документация:**
- `README.md` - Документация бота
- `CLIENT_README.md` - Документация клиента
- `CLIENT_ARCHITECTURE.md` - Архитектура клиента
- `QUICKSTART_CLIENT.md` - Быстрый старт
- `INTEGRATION_GUIDE.md` - Этот файл

**Удачного бронирования! 🚀**
